name: Build Linux (arm64) PyInstaller bundle

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Pull base image (debug)
        run: |
          set -x
          docker pull --platform=linux/arm64 python:3.11-slim || true
          echo "=== docker run uname ==="
          docker run --rm --platform=linux/arm64 python:3.11-slim uname -a || true
          echo "=== python version inside image ==="
          docker run --rm --platform=linux/arm64 python:3.11-slim python -V || true

      - name: Run build in container (verbose)
        run: |
          set -x
          docker run --rm --platform=linux/arm64 -v "${GITHUB_WORKSPACE}":/src -w /src python:3.11-slim bash -lc '
            set -euo pipefail
            echo "--- apt-get update ---"
            apt-get update -o Acquire::Retries=3 || (cat /var/log/apt/term.log || true; exit 2)
            echo "--- apt-get install ---"
            apt-get install -y --no-install-recommends \
              build-essential libxcb1 libx11-6 libxcb-xinerama0 libxrender1 libxext6 libgl1 libxkbcommon0 libglib2.0-0 || (cat /var/log/apt/term.log || true; exit 2)
            echo "--- pip upgrade/install ---"
            python -m pip install --upgrade pip setuptools wheel
            pip install -r requirements.txt pyinstaller
            echo "--- running pyinstaller ---"
            set -x
            pyinstaller --noconfirm --clean --log-level=DEBUG --windowed --add-data "示例数据:示例数据" --add-data "database:database" --name workbook main.py
            echo "--- packaging artifact ---"
            mkdir -p /src/dist_output
            tar -czf /src/dist_output/workbook-linux-arm64.tar.gz -C /src/dist workbook
          '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: workbook-linux-arm64
          path: dist_output/workbook-linux-arm64.tar.gz
          retention-days: 7

      - name: Show dist listing
        run: |
          ls -la dist || true
          ls -la dist_output || true
