# 异常统计导出功能更新说明

## 问题描述

用户反馈异常情况统计页面的导出功能缺少"训练"和"管理"两列，导出的Excel文件不完整。

## 问题分析

经检查发现：
1. **UI界面**：异常统计表格已包含训练和管理列
2. **数据库视图**：异常统计视图已包含`training_status`和`management_status`字段
3. **导出功能**：导出代码仍使用旧的8列格式，未包含训练和管理列

## 解决方案

### 1. 更新导出表头

**修改前（8列）**：
```python
headers = ['日期', '姓名', '性别', '公民身份号码', '思想', '身体', '精神', '其他']
```

**修改后（15列）**：
```python
headers = ['日期', '姓名', '性别', '公民身份号码', '连', '排', '班', '应征地', '带训班长', '思想', '身体', '精神', '训练', '管理', '其他']
```

### 2. 更新数据查询逻辑

**修改前**：使用旧的`exception_statistics`表直接查询
```python
cursor.execute('''
    SELECT data, name, gender, user_id, thought, body, Spirit, other
    FROM exception_statistics
    ORDER BY data DESC, updated_at DESC
''')
```

**修改后**：使用异常统计视图获取完整数据
```python
data = self.db_manager.get_exception_statistics_view_data()
```

### 3. 更新字段映射

建立了完整的字段映射关系：
```python
result_tuple = (
    record[14],  # 日期
    record[1],   # 姓名
    record[2],   # 性别
    record[0],   # 公民身份号码
    record[3],   # 连
    record[4],   # 排
    record[5],   # 班
    record[7],   # 应征地
    record[6],   # 带训班长
    record[8],   # 思想是否异常
    record[9],   # 身体是否异常
    record[10],  # 精神是否异常
    record[11],  # 训练是否异常 ← 新增
    record[12],  # 管理是否异常 ← 新增
    f"来源:{record[13]}" if record[13] else ""  # 其他
)
```

## 修改的文件

### 1. `ui/main_window.py`
- 更新`export_data()`方法中的异常统计导出逻辑
- 更新`get_selected_exception_statistics_data()`方法

### 2. `ui/main_window_temp.py`
- 同步更新导出功能
- 同步更新选中数据获取方法

## 功能验证

### 测试结果
✅ **数据完整性**：导出包含所有15列数据  
✅ **字段映射**：所有字段正确映射  
✅ **训练异常**：发现3条训练异常记录  
✅ **管理异常**：发现1条管理异常记录  
✅ **格式兼容**：Excel文件格式正确  

### 导出内容对比

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 列数 | 8列 | 15列 |
| 基本信息 | 4列 | 4列 |
| 组织信息 | 0列 | 5列（连、排、班、应征地、带训班长） |
| 异常状态 | 3列 | 5列（思想、身体、精神、**训练**、**管理**） |
| 其他信息 | 1列 | 1列 |

## 使用说明

### 导出操作
1. 进入"异常情况统计"页面
2. 可选择特定记录或导出全部数据
3. 点击"导出数据"按钮
4. 选择保存位置和文件名
5. 确认导出

### 导出文件结构
导出的Excel文件包含以下列：

**基本信息**：
- 日期
- 姓名  
- 性别
- 公民身份号码

**组织信息**：
- 连
- 排
- 班
- 应征地
- 带训班长

**异常状态**：
- 思想（正常/异常）
- 身体（正常/异常）
- 精神（正常/异常）
- **训练（正常/异常）** ← 新增
- **管理（正常/异常）** ← 新增

**异常来源**：
- 其他（显示具体来源信息）

## 技术细节

### 数据源
- 使用`v_exception_statistics`视图
- 包含完整的异常统计信息
- 自动关联青年基本信息

### 字段说明
- **训练异常**：来源于每日统计中的训练状态
- **管理异常**：来源于每日统计中的管理状态
- **异常来源**：显示具体的异常数据来源（如：病史筛查、体检、每日统计等）

### 兼容性
- 向后兼容现有功能
- 不影响其他模块的导出功能
- 保持数据格式的一致性

## 总结

通过本次更新，异常情况统计的导出功能现在能够：

1. **完整导出**：包含所有15列数据，不再遗漏训练和管理列
2. **数据准确**：使用标准的异常统计视图，确保数据一致性
3. **格式统一**：选中导出和全部导出使用相同的数据格式
4. **功能完善**：支持完整的异常情况分析和统计

用户现在可以获得完整的异常情况统计报表，包括训练和管理方面的异常信息，便于进行全面的数据分析和管理决策。

---

**更新时间**：2026年2月1日  
**版本**：v2.4  
**状态**：已完成并测试通过